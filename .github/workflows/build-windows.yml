name: Build Windows EXE with Nuitka

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper versioning

    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    # Note: GitHub Actions windows-latest runner already includes Visual Studio Build Tools
    # Nuitka will automatically detect and use the MSVC compiler
    # No additional setup needed unless build fails

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        
        # Install Nuitka
        pip install nuitka ordered-set zstandard
        
        # Install PyTorch with CUDA 11.8 support (for GPU) - install first to avoid conflicts
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
        
        # Install ONNX Runtime GPU - install first to avoid conflicts
        pip install onnxruntime-gpu
        
        # Install other dependencies from requirements.txt, but skip torch/onnxruntime to avoid version conflicts
        # Create a temporary requirements file without torch/onnxruntime
        Get-Content requirements.txt | Where-Object { 
            $line = $_.Trim()
            $line -and $line -notmatch '^torch' -and $line -notmatch '^torchvision' -and $line -notmatch '^torchaudio' -and $line -notmatch '^onnxruntime'
        } | Out-File -FilePath requirements_temp.txt -Encoding utf8
        
        # Install remaining dependencies
        pip install -r requirements_temp.txt
        
        # Cleanup
        Remove-Item requirements_temp.txt
      env:
        PIP_NO_CACHE_DIR: false

    - name: Verify GPU support
      run: |
        python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}')"
        python -c "import onnxruntime as ort; print(f'ONNX Runtime version: {ort.__version__}'); print(f'Available providers: {ort.get_available_providers()}')"
      continue-on-error: true

    - name: Verify weights directory
      run: |
        if (Test-Path "weights") {
          Write-Host "✓ Weights directory found"
          Get-ChildItem -Path weights -Recurse -File | Select-Object FullName
        } else {
          Write-Host "❌ Weights directory not found!"
          exit 1
        }

    - name: Build with Nuitka (Standalone)
      run: |
        python -m nuitka `
          --standalone `
          --windows-console-mode=force `
          --assume-yes-for-downloads `
          --enable-plugin=numpy `
          --include-package=onnxruntime `
          --include-package=PIL `
          --include-package=cv2 `
          --include-package=pydicom `
          --include-package=fastapi `
          --include-package=uvicorn `
          --include-package=torchvision `
          --include-data-dir=weights=weights `
          --include-data-dir=src=src `
          --include-data-files=data/api_keys.json=data/api_keys.json `
          --include-data-files=data/admin_vault.json=data/admin_vault.json `
          --output-dir=dist `
          --show-progress `
          --show-memory `
          --report=compilation-report.xml `
          run.py
      env:
        NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache

    - name: Verify build output
      run: |
        if (Test-Path "dist\run.dist") {
          Write-Host "✓ Build successful!"
          
          # Check main executable
          if (Test-Path "dist\run.dist\run.exe") {
            $size = (Get-Item "dist\run.dist\run.exe").Length / 1MB
            Write-Host "Main executable size: $([math]::Round($size, 2)) MB"
          }
          
          # Count total files
          $fileCount = (Get-ChildItem -Path "dist\run.dist" -Recurse -File).Count
          Write-Host "Total files in distribution: $fileCount"
          
          # Calculate total size
          $totalSize = (Get-ChildItem -Path "dist\run.dist" -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Total distribution size: $([math]::Round($totalSize, 2)) MB"
        } else {
          Write-Host "❌ Build failed - distribution folder not found!"
          exit 1
        }

    - name: Create release package
      run: |
        New-Item -ItemType Directory -Force -Path release
        
        # Copy entire standalone distribution
        Copy-Item "dist\run.dist" "release\medical_xray_analyzer" -Recurse
        
        # Rename main executable
        Move-Item "release\medical_xray_analyzer\run.exe" "release\medical_xray_analyzer\medical_xray_analyzer.exe"
        
        # Copy documentation
        Copy-Item "README.md" "release\" -ErrorAction SilentlyContinue
        Copy-Item "BUILD_GUIDE.md" "release\" -ErrorAction SilentlyContinue
        Copy-Item "docs" "release\docs" -Recurse -ErrorAction SilentlyContinue
        
        # Create start script
        @"
        @echo off
        echo ========================================
        echo Medical X-ray Analyzer API Server
        echo ========================================
        echo.
        cd medical_xray_analyzer
        medical_xray_analyzer.exe --host 0.0.0.0 --port 8000
        pause
        "@ | Out-File -FilePath "release\start_server.bat" -Encoding ASCII
        
        # Create README for release
        @"
        # Medical X-ray Analyzer - Windows Distribution
        
        ## Quick Start
        
        1. Double-click 'start_server.bat' to start the API server
        2. Server will run on http://localhost:8000
        3. API documentation: http://localhost:8000/docs
        
        ## Manual Start
        
        ```
        cd medical_xray_analyzer
        medical_xray_analyzer.exe --host 0.0.0.0 --port 8000
        ```
        
        ## Options
        
        - --host: Host to bind (default: 0.0.0.0)
        - --port: Port to bind (default: 8000)
        - --reload: Enable auto-reload (dev mode)
        
        ## Requirements
        
        - Windows 10/11 (64-bit)
        - No Python installation needed
        - All dependencies included
        
        ## Documentation
        
        See BUILD_GUIDE.md and docs/ folder for more information.
        "@ | Out-File -FilePath "release\README_WINDOWS.txt" -Encoding UTF8

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: medical-xray-analyzer-windows-x64
        path: release/
        retention-days: 30

    - name: Prepare compilation report
      if: always()
      run: |
        # Find compilation report (could be in root or dist/)
        if (Test-Path "compilation-report.xml") {
          Write-Host "✓ Found compilation-report.xml in root"
        } elseif (Test-Path "dist\compilation-report.xml") {
          Write-Host "✓ Found compilation-report.xml in dist/, copying to root"
          Copy-Item "dist\compilation-report.xml" "compilation-report.xml"
        } else {
          Write-Host "⚠ Warning: compilation-report.xml not found (this is OK if build failed early)"
        }
      continue-on-error: true

    - name: Upload compilation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: compilation-report
        path: compilation-report.xml
        if-no-files-found: ignore
        retention-days: 7

    - name: Create ZIP archive for release
      run: |
        Compress-Archive -Path "release\*" -DestinationPath "medical-xray-analyzer-windows-x64.zip"
        
        # Show final size
        $zipSize = (Get-Item "medical-xray-analyzer-windows-x64.zip").Length / 1MB
        Write-Host "Final ZIP size: $([math]::Round($zipSize, 2)) MB"

    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: medical-xray-analyzer-windows-x64.zip
        body: |
          ## Medical X-ray Analyzer - Windows Release
          
          ### Installation
          1. Download `medical-xray-analyzer-windows-x64.zip`
          2. Extract to any folder
          3. Run `start_server.bat`
          
          ### What's Included
          - Standalone executable (no Python needed)
          - All model weights
          - API server
          - Documentation
          
          ### System Requirements
          - Windows 10/11 (64-bit)
          - ~2GB disk space
          - 4GB+ RAM recommended
          
          See README_WINDOWS.txt for detailed instructions.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
